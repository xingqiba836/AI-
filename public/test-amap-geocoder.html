<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>测试高德地理编码</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .log { margin: 10px 0; padding: 10px; background: #f0f0f0; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>高德地图地理编码测试</h1>
    <p>API Key: 1e25b66013ee7ab6ac4de0b6c81940d6</p>
    <button onclick="testGeocode()">测试地理编码</button>
    <div id="logs"></div>

    <script type="text/javascript">
        const API_KEY = '1e25b66013ee7ab6ac4de0b6c81940d6';
        
        function log(message, isError = false) {
            const div = document.createElement('div');
            div.className = 'log ' + (isError ? 'error' : 'success');
            div.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            document.getElementById('logs').appendChild(div);
            console.log(message);
        }

        // 加载高德地图
        function loadAMap() {
            return new Promise((resolve, reject) => {
                log('开始加载高德地图 API...');
                
                const script = document.createElement('script');
                script.src = `https://webapi.amap.com/maps?v=2.0&key=${API_KEY}&plugin=AMap.Geocoder`;
                
                script.onload = () => {
                    setTimeout(() => {
                        if (window.AMap) {
                            log('✅ 高德地图 API 加载成功，版本: ' + window.AMap.version);
                            resolve(window.AMap);
                        } else {
                            log('❌ AMap 对象未定义', true);
                            reject(new Error('AMap undefined'));
                        }
                    }, 100);
                };
                
                script.onerror = () => {
                    log('❌ 脚本加载失败', true);
                    reject(new Error('Script load failed'));
                };
                
                document.head.appendChild(script);
            });
        }

        async function testGeocode() {
            try {
                document.getElementById('logs').innerHTML = '';
                
                const AMap = await loadAMap();
                
                log('开始测试地理编码...');
                
                // 方法1: 使用 plugin 加载
                AMap.plugin('AMap.Geocoder', function() {
                    log('✅ Geocoder 插件加载成功');
                    
                    const geocoder = new AMap.Geocoder({
                        city: '南京'
                    });
                    
                    log('✅ Geocoder 实例创建成功');
                    log('→ 调用 getLocation("南京玄武区紫金山")');
                    
                    // 添加超时检测
                    const timeout = setTimeout(() => {
                        log('⏱️ 10秒超时，回调未触发！', true);
                    }, 10000);
                    
                    geocoder.getLocation('南京玄武区紫金山', function(status, result) {
                        clearTimeout(timeout);
                        
                        log('← getLocation 回调触发！');
                        log('   status: ' + status);
                        log('   info: ' + (result ? result.info : 'undefined'));
                        
                        if (status === 'complete' && result.info === 'OK') {
                            const loc = result.geocodes[0].location;
                            log('✅ 地理编码成功: ' + loc.lng + ', ' + loc.lat);
                        } else {
                            log('❌ 地理编码失败: ' + (result ? result.info : status), true);
                        }
                    });
                    
                    log('getLocation 方法已调用，等待回调...');
                });
                
            } catch (error) {
                log('❌ 测试失败: ' + error.message, true);
            }
        }
    </script>
</body>
</html>

